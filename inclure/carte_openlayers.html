<script type="text/javascript">
<!--
(function($){
	
	var map, strategy, clusters, features, select_control, selected_feature, popup, kml;
	var wgs84 = new OpenLayers.Projection("EPSG:4326");
	
	$(function(){

		// <BOUCLE_gis(GIS){id_article}>
		// centrer sur l'article passe dans l'url
		// #SET{lat,#LAT} #SET{lon,#LON} #SET{zoom,#ZOOM}
		// </BOUCLE_gis>
		[(#REM) Sinon centrer sur les coordonnes passees en parametre ou sur celle par defaut ]
		[(#GET{lat}|non)
		#SET{lat,#ENV{lat,#CONFIG**{gis/lat,0}}}]
		[(#GET{lon}|non)
		#SET{lon,#ENV{lon,#CONFIG**{gis/lon,0}}}]
		[(#GET{zoom}|non)
		#SET{zoom, #ENV{zoom,#CONFIG**{gis/zoom,0}}]

		var infowindow_close = function(evt) {
			select_control.unselect(selected_feature);
			map.removePopup(popup);
		}	

		var infowindow = function(feature,content) {
			// virer la popup précédente si nécessaire
			if (typeof popup!='undefined') {
				popup.destroy();
			}
			OpenLayers.Popup.geolPopup = OpenLayers.Class(OpenLayers.Popup.Anchored, {
				'displayClass' : 'geol_window', // classe perso sur la popup
				'autoSize' : true,
				'relativePosition' : 'tl', // fonctionne pas...
				'panMapIfOutOfView' : true // fonctionne pas...
			});
			popup = new OpenLayers.Popup.geolPopup(
				'popup',
				feature.geometry.getBounds().getCenterLonLat(),
				null, // taille de la popup à null pour l'autosize qui suit
				content,
				null,
				true,
				infowindow_close
			);
			feature.popup = popup;
			map.addPopup(popup);
			// virer la popup au changement de zoom
			map.events.register("zoomend", map, function(evt){
				if (typeof popup!='undefined') {
					map.removePopup(popup);
				}
			});
		}
		
		var marker_select = function(feature) {
			var extUrl = "[(#URL_PAGE{get_infowindow})]";
			if (feature.attributes.count > 1) {
				// si c'est un cluster
				if (map.numZoomLevels == map.getZoom()) {
					// et qu'on est au zoom maxi de la carte
					selected_feature = feature;
					// récupérer les id des markers du cluster
					var features = new Array();
					$.each(feature.cluster,function(i,feature){
						features.push(feature.attributes.id);
					});
					// et ouvrir une infowindow multiple
					$.ajax({
						url: extUrl,
						data: { id_article : features },
						success: function(data){
							infowindow(feature,data);
						}
					});
				} else {
					// sinon centrer la cartes sur les bounds du cluster
					var bounds = new OpenLayers.Bounds();
					$.each(feature.cluster,function(i,feature){
						bounds.extend(feature.geometry);
					});
					map.zoomToExtent(bounds);
				}
			} else {
				// si c'est un marker, ouvir une infowindow dont on récupère le contenu en ajax
				selected_feature = feature;
				$.ajax({
					url: extUrl,
					data: { id_article : feature.cluster[0].attributes.id },
					success: function(data){
						infowindow(feature.cluster[0],data);
					}
				});
			}
		}
        		
		var initMap = function() {

			// <BOUCLE_kml(ARTICLES documents_liens documents){id_article}{mode=document}{documents.extension IN 'kml','kmz'}>
			// superposer le kml de l'article passe en url
			kml = new OpenLayers.Layer.GML("kml", "[(#URL_DOCUMENT|url_absolue)]",{
				'format': OpenLayers.Format.KML,
				'formatOptions': new OpenLayers.Format.KML({
					'extractStyles': true,
					'extractAttributes': true
				}),
				'projection': new OpenLayers.Projection('EPSG:4326')
			});
			#SET{kml,oui}
			// </BOUCLE_kml>

			// charger les markers sauf si on superpose un kml
			[(#GET{kml}|non)
			$.getJSON("#PRODUIRE{fond=geol_markers.json,id_auteur=#ENV{id_auteur},id_mot=#ENV{id_mot},id_rubrique=#ENV{id_rubrique}}",
				function(data) {
					if (data) {
						features = new Array();
						$.each(data.markers, function(i,item){
							if (item.lat) {
								// convertir les coords des points de wgs84 vers spherical mercator
								var latlng = new OpenLayers.Geometry.Point(item.lon,item.lat).transform(wgs84, map.getProjectionObject());
								var marker = new OpenLayers.Feature.Vector(latlng,{x:item.lon,y:item.lat});
								if (item.icon) {
									marker.attributes.icon = item.icon;
								}
								marker.attributes.id = item.id;
								//marker.attributes.label = item.name;
								features.push(marker);
							}
						});
						clusters.addFeatures(features);
					}
				}
			);]

			// créer la carte
			var map_container = 'geomap';
			map = new OpenLayers.Map('geomap', {
				maxExtent: new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34),
				maxResolution: 156543,
				numZoomLevels: 18,
				units: 'm',
				projection: 'EPSG:900913', // spherical mercator (metres) par defaut pour osm
				displayProjection: wgs84, // wgs84 (lonlat) pour affichage des coords
				controls:[
					new OpenLayers.Control.Navigation(),
					new OpenLayers.Control.PanZoomBar(),
					new OpenLayers.Control.ScaleLine()
				]
			});
			
			// utiliser les controles persos de mapbox
			OpenLayers.ImgPath = "[(#CHEMIN{images/openlayers/dark/})]";
			// couche OSM de base
			//var base = new OpenLayers.Layer.OSM();
			//var base = new OpenLayers.Layer.OSM("t@h", "http://tah.openstreetmap.org/Tiles/tile/${z}/${x}/${y}.png");
			//var base = new OpenLayers.Layer.OSM("MapQuest", "http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png");
			var base = new OpenLayers.Layer.OSM("Acetate", "http://acetate.geoiq.com/tiles/acetate-hillshading/${z}/${x}/${y}.png");
			// on prépare la couche du cluster
			var style = new OpenLayers.Style({
				pointRadius: "${radius}",
				externalGraphic: "${icon}",
				label: "${label}",
				fontColor: "#ffffff",
				cursor: "pointer"
			}, {
				context: {
					radius: function(feature) {
						if (feature.attributes.count > 1) {
							return 20;
						}
						return 16;
					},
					icon: function(feature) {
						if (feature.attributes.count > 1) {
							return "#CHEMIN{images/bg_cluster.png}";
						}
						return feature.cluster[0].attributes.icon;
					},
					label: function(feature) {
						if (feature.attributes.count > 1) {
							return feature.attributes.count;
						}
						return '';
					}
				}
			});
			strategy = new OpenLayers.Strategy.Cluster();
			strategy.distance = 60;
			clusters = new OpenLayers.Layer.Vector("Clusters", {
				strategies: [strategy],
				styleMap: new OpenLayers.StyleMap({
					"default": style,
					"select": { cursor: "pointer" } // surcharger les styles de select par défaut pour ne pas réduire l'icone au select
				})
			});
			
			// attacher notre fonction au click des markers du cluster
			
			// http://docs.openlayers.org/library/overlays.html#interaction
			//clusters.events.register("featureselected", clusters, marker_click);
			//var select = new OpenLayers.Control.SelectFeature(clusters);
			
			// autre solution qui permet de se passer de clusters.events.register 
			// et qui passe directement le feature au callback
			select_control = new OpenLayers.Control.SelectFeature(clusters,{onSelect: marker_select});
			map.addControl(select_control);
			select_control.activate();

			map.addLayer(base);
			map.addLayer(clusters);
			[(#GET{kml}|oui)
			map.addLayer(kml);]
			// convertir les coords des points de wgs84 vers spherical mercator
			map.setCenter(new OpenLayers.LonLat(#GET{lon}, #GET{lat}).transform(wgs84, map.getProjectionObject()), #ENV{zoom,#CONFIG{gis/zoom,0}});
			
			[(#ENV{id_auteur}|oui|ou{#ENV{id_mot}|oui}|ou{#ENV{id_rubrique}|ou{#GET{kml}|oui}|oui})
			// carte filtree
			infoFilter();
			]			
			
		};
		
		// resize la carte si chgt de taille sur window
		var resizeMap = function() {
			var top_h = $('#top').height();
			var page_h = $('#page').height();
			$('#geomap').height(page_h - top_h);
		};
		
		// afficher un message si la carte est filtrée sur un ou plusieurs id
		var infoFilter = function() {
			var close_filtre = '<a href="#URL_PAGE{carte}" id="close_filtre" title="<:geol:recherche_retirer_filtre|attribut_html:>"><:geol:annuler:></a>';
			var filtre = new Array();
			[filtre.push('#INFO_NOM{auteur,#ENV{id_auteur}}');(#ENV{id_auteur}|oui)]
			[filtre.push('#INFO_TITRE{mot,#ENV{id_mot}}');(#ENV{id_mot}|oui)]
			[filtre.push('#INFO_TITRE{rubrique,#ENV{id_rubrique}}');(#ENV{id_rubrique}|oui)]
			[(#GET{kml}|oui)
			filtre.push('#INFO_TITRE{article,#ENV{id_article}}');]
			$('<span class="info_filtre">'+ filtre.join(", ") +' '+ close_filtre +'</span>')
				.insertBefore('#menu_moi')
				.hide().fadeIn(3500);
		};
		
		// panel de gestion des kml dans #navigation
		// overlay du kml si clique sur le checkbox correspondant
		$('#kml_panel input.kml:checkbox').each(function(i) {
			var id = $(this).attr('id');
			var kml_url = $(this).val();
			$(this).bind ('click',function(){
				if ($(this).attr('checked')) {
					if (typeof(clusters) != "undefined") {
						clusters.removeFeatures(clusters.features);
					}
					$('#kml_panel input#medias:checkbox').attr('checked',false);
					kml = new OpenLayers.Layer.GML("kml", kml_url,{
						'format': OpenLayers.Format.KML,
						'formatOptions': new OpenLayers.Format.KML({
							'extractStyles': true,
							'extractAttributes': true
						}),
						'projection': new OpenLayers.Projection('EPSG:4326')
					});
					map.addLayer(kml);
				} else {
					map.removeLayer(kml);
				}
			});
		});
		$('#kml_panel input#medias:checkbox').click(function() {
			if ($(this).attr('checked')) {
				clusters.addFeatures(features);
			} else {
				clusters.removeFeatures(clusters.features);
			}
		})[(#GET{kml}|?{".attr('checked',false);",";"})]		
		
		//  deplier/replier le panel
		$('#kml_panel #toggle').click(function() {
			$('#kml_panel').toggleClass('replie');
			$('#kml_panel ul.liste-items').slideToggle();
		});
		// panel draggable
		$('#kml_panel').draggable({
			containment: '#contenu',
			handle: 'h3'
		});
		
		// init de la carte
		if ($.browser.msie) {
			$(window).load(initMap);
			resizeMap();
		} else {
			resizeMap();
			initMap();
		};
		
		// window resize ?
		$(window).resize(function(){
			resizeMap();
		});
		
		// ajouter le bouton pour afficher/masquer le pied
		// puis le faire glisser hors de la fenetre au chargement
		$('#pied .conteneur').append('<div id="bouton"> </div>');
		var pied_h = $('#pied').height();
		$(window).load(function(){
			$('#pied').animate({"bottom": (0-pied_h)}, { duration: "slow" }).toggleClass('cache');
		});
		$('#bouton').toggle(
			function(){
				$('#pied').animate({"bottom": 0}, { duration: "slow" }).toggleClass('cache');
			},
			function(){
				$('#pied:not(.cache)').animate({"bottom": (0-pied_h)}, { duration: "slow" }).toggleClass('cache');
			}
		);
		
		// formulaire de recherche geocoding
		$("#formulaire_recherche form").submit(function(){
			var address = {};
			address.address = $("#recherche").attr("value");
			var geocoder = new mxn.Geocoder('openlayers',function(geocoded_location){
				// convertir les coords des points de wgs84 vers spherical mercator
				map.setCenter(new OpenLayers.LonLat(geocoded_location.point.lon, geocoded_location.point.lat).transform(wgs84, map.getProjectionObject()), map.getZoom());
			});
			geocoder.geocode(address);
			return false;
		});
	})
})(jQuery)
// -->
</script>